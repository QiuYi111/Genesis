# 交互式角色扮演功能规划

## 1. 目标与背景
- **问题**：当前模拟主要是旁观式体验，缺乏即时的用户参与感。
- **目标**：允许真实用户在运行中的世界中直接扮演两个核心身份：
  1. 普通 Agent（以个体视角行动、观察世界反馈）。
  2. Trinity（以“神”视角管理生态、调节规则）。
- **价值**：提升体验沉浸感、验证系统的交互边界，同时收集人类决策数据以改进 AI Agent 的策略。

## 2. 关键使用场景
### 2.1 用户扮演 Agent
1. 用户从 UI 选择一个现有或新生成的角色。
2. 系统展示角色当前状态（位置、资源、关系、目标）。
3. 用户通过对话框或指令界面提交行动（如移动、采集、交易）。
4. 模拟引擎执行用户行动，产出反馈，并在下一回合继续自动模拟其他 AI Agent。

### 2.2 用户扮演 Trinity
1. 用户在 UI 切换到“Trinity 控制台”。
2. 控制台展示世界指标（资源分布、生态平衡、社会指标）。
3. 用户选择可用的 Trinity 行动（调整资源概率、触发事件、气候变化等）。
4. 系统校验行动合法性，应用到世界状态，并广播结果给所有 Agent。

## 3. 功能模块拆解
| 模块 | 主要任务 | 备注 |
| --- | --- | --- |
| 身份管理 | 登录/访客模式、选择扮演身份、权限控制 | 首期可用匿名访客，后续扩展账号体系 |
| 行动接口 | 统一封装用户指令 → 模拟引擎 API | 需要对现有 `agent_action` / `trinity_action` API 做适配 |
| 状态展示 | 面向角色的世界视图（角色局部 vs. 全局仪表板） | 利用既有日志/观测数据结构 |
| 交互历史 | 记录用户操作、系统回应、世界变化 | 便于回放与数据分析 |
| 安全控制 | 节流、权限验证、防止破坏性操作 | Trinity 行动需加入冷却/预算限制 |

## 4. 技术方案概览
```
[Web UI] --(REST/WebSocket)--> [Interaction Gateway] --(事件总线)--> [Simulation Core]
                                                   ↘︎ [Audit Log]
```
- **Web UI**：新增“角色面板”“Trinity 控制台”，支持实时状态刷新。
- **Interaction Gateway**：位于后端（FastAPI/Starlette）。接收用户操作，完成身份校验、参数解析、调用模拟核心。
- **Simulation Core**：沿用现有世界/Agent/Trinity 模块，增加 `HumanAgentController`、`HumanTrinityController` 适配层。
- **Audit Log**：存储用户输入、系统响应、世界状态快照。

## 5. 详细工作包
### 5.1 身份选择与会话管理
- 为 Web UI 增加“进入模拟”入口，允许选择 **观众 / Agent / Trinity** 模式。
- 在服务器端为每个会话分配 `session_id`，并在内存中保存身份与控制权。
- Trinity 模式限制同时仅允许 1 位用户；Agent 模式可同时存在多个用户，每人绑定不同角色。

### 5.2 用户行动通道
- **Agent 模式**：
  - 新建 `POST /interact/agent/{agent_id}` 接口，提交结构化行动（JSON）。
  - 在模拟循环中插入钩子：若轮到该 Agent 行动且被用户控制，则等待用户指令或使用回退策略（超时后改由 AI 接管）。
- **Trinity 模式**：
  - 新建 `POST /interact/trinity` 接口，对接已有 Trinity 行为集合。
  - 支持批量行动，必要时加入事务回滚，以防半成功状态。

### 5.3 前端 UI & 交互设计
- 扩展 `web_ui/index.html`：
  - 新增“角色选择”对话框。
  - Agent 面板：实时属性（体力、背包、社交关系）、行动按钮、行动历史。
  - Trinity 面板：世界概览图、资源概率调节滑块、事件触发按钮、冷却计时。
- 使用 WebSocket 推送世界更新，保证用户能看到回合结果与其他 Agent 行为。
- 增加输入校验与提示（例如 Trinity 行动超出权限时给出解释）。

### 5.4 模拟核心适配
- 在 `sociology_simulation.agent` 中添加 `HumanControlledAgent` 状态，用于标记是否等待用户输入。
- 在回合循环中：
  - 检查 `agent.is_human_controlled`，若为真则调用 `interaction_gateway.wait_for_action(agent_id)`。
  - 超时处理：恢复 AI 控制，记录日志。
- 在 `trinity` 模块中新增 `HumanTrinityActionProcessor`，复用已有生态管理逻辑，但来自用户输入。
- 增加审计记录：写入 `logs/human_interactions.jsonl`。

### 5.5 提示词与对话支持
- 为 Agent 模式提供可选的“AI 建议”按钮：调用原有 LLM 提示，给出推荐行动供用户参考。
- 为 Trinity 模式提供行动解释器：当用户选择行动时，展示该行动的生态影响预测（基于当前规则计算）。

### 5.6 数据与分析
- 记录用户行动、世界状态、系统回应，用于：
  - 评估人类决策对模拟的影响。
  - 构建数据集，训练/微调未来的策略模型。
- 在 `docs/examples/` 中新增使用指南，展示如何回放用户交互。

## 6. 里程碑排期
| 里程碑 | 时间 | 产出 |
| --- | --- | --- |
| M1: 设计定稿 | 第 1 周 | 原型交互流程、API 契约、UI 草图 |
| M2: 后端网关 | 第 2 周 | Interaction Gateway、会话管理、模拟钩子 |
| M3: Agent 扮演 Beta | 第 3 周 | Agent 控制 UI、基本行动（移动/采集/交流） |
| M4: Trinity 扮演 Beta | 第 4 周 | Trinity 控制台、核心生态行动、冷却限制 |
| M5: 稳定性与分析 | 第 5 周 | 压测、日志分析工具、文档发布 |

## 7. 风险与缓解
- **实时性不足**：模拟步长较长或回合阻塞 → 加入异步队列、设置行动超时与默认策略。
- **权限滥用**：Trinity 行动过于强力 → 实施冷却、资源预算、回合限额。
- **UI 复杂度**：界面信息过多导致学习成本高 → 分层显示信息、提供新手提示。
- **多用户冲突**：多个用户争夺同一身份 → 使用排队/预约机制，并在 UI 上提示等待状态。

## 8. 验收标准
- 用户能在 3 次点击内进入 Agent 模式，并完成一次完整行动。
- Trinity 模式下的用户行动能在下一回合内对世界产生可见影响。
- 所有用户操作与结果被记录，可通过命令导出 (`python scripts/export_human_interactions.py`)。
- 关键流程（身份切换、行动提交、日志记录）具备端到端测试覆盖。

## 9. 后续扩展
- 结合语音输入、自然语言解析，降低操作门槛。
- 引入多人协作模式（多位用户控制同一部落/阵营）。
- 将人类数据用于强化学习，训练更智能的 Trinity 策略。
- Web UI 增加“回放模式”，回顾完整交互历史。

